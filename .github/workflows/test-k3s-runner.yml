name: âš¡ Teste K3s Runner

# Teste de funcionamento dos runners - v3 com runner ativo
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      runner_name:
        description: 'Nome do runner'
        required: false
        default: 'self-hosted'

jobs:
  test-runner:
    name: ğŸš€ Teste do Runner K3s
    runs-on: [self-hosted, actions-runners]
    
    steps:
      - name: ğŸ“‹ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ‘‹ Hello K3s!
        run: |
          echo "ğŸ‰ OlÃ¡ do runner no k3s!"
          echo "ğŸ“… Data: $(date)"
          echo "ğŸ–¥ï¸  Hostname: $(hostname)"
          echo "ğŸ‘¤ UsuÃ¡rio: $(whoami)"
          echo "ğŸ”§ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸƒ Runner funcionando!"
      
      - name: ğŸ³ Teste Docker
        run: |
          echo "ğŸ”¨ Testando Docker:"
          docker --version
          docker run --rm alpine:latest echo "Docker funcionando no k3s!"
      
      - name: â˜¸ï¸  Teste Kubectl
        run: |
          echo "ğŸ“‹ Nodes do cluster:"
          kubectl get nodes
          echo ""
          echo "ğŸ“¦ Namespaces:"
          kubectl get namespaces | head -10
          echo ""
          echo "ğŸƒ Runners ativos:"
          kubectl get pods -n actions-runners | grep Running || echo "Nenhum pod encontrado"
      
      - name: ğŸ§ª Teste de Build
        run: |
          echo "ğŸ—ï¸  Testando build de imagem:"
          cat > Dockerfile << 'EOF'
          FROM alpine:latest
          RUN echo "Build automÃ¡tico no k3s!" > /test.txt
          CMD cat /test.txt
          EOF
          
          docker build -t test-auto-build .
          docker run --rm test-auto-build
      
      - name: ğŸ“Š InformaÃ§Ãµes do Sistema
        run: |
          echo "ğŸ’¾ MemÃ³ria disponÃ­vel:"
          free -h | head -2
          echo ""
          echo "ğŸ’½ EspaÃ§o em disco:"
          df -h / | tail -1
          echo ""
          echo "ğŸ”¥ CPU:"
          echo "Cores: $(nproc)"
      
      - name: âœ… Teste ConcluÃ­do
        run: |
          echo "ğŸŠ Teste concluÃ­do com sucesso!"
          echo "âœ¨ O runner estÃ¡ funcionando perfeitamente!"
          echo "ğŸš€ Pronto para CI/CD no k3s!" 